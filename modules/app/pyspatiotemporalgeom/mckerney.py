import collections
import structureRegion

import componentMovingRegion
import pyspatiotemporalgeom.region as region
import os
from utilities import regionInterpolator
from utilities import hsegLibrary
from utilities import triangleLibrary
from utilities import mapLibrary
import pyspatiotemporalgeom.componentMovingRegion as intervalRegion
from pyspatiotemporalgeom.componentMovingRegion import cIntervalRegion
import sys
import re
#import imp
#structureRegion = imp.load_source('structureRegion', "pyspatiotemporalgeom\\structureRegion.py")
#intervalRegion = imp.load_source('intervalRegion', "pyspatiotemporalgeom\\componentMovingRegion.py")

import random
#def t():
#    print(sys.path)

"""
# create 4 structural regions
sr1 = structureRegion.structuralRegion()
sr1f1 = [((2,1),(4,1)),((4,1),(3,4)),((3,4),(2,1))]
sr1h1 = [((4,2),(5,2)),((5,2),(5,3)),((5,3),(4,2))]
sr1f1ID = sr1.addFace( sr1f1 )
#sr1h1 = sr1.addHole( sr1h1, [sr1f1ID] )
sr2 = structureRegion.structuralRegion()
sr2f1 = [((2,1),(4,1)),((4,1),(3,4)),((3,4),(2,1))]
sr2h1 = [((1,2),(2,2)),((2,2),(2,3)),((2,3),(1,2))]
sr2f1ID = sr2.addFace( sr2f1 )
#sr2h1 = sr2.addHole( sr2h1, [sr2f1ID] )
sr3 = structureRegion.structuralRegion()
sr3f1 = [((1,1),(2,1)),((2,1),(1,2)),((1,2),(1,1))]
sr3f1ID =sr3.addFace( sr3f1 )
sr4 = structureRegion.structuralRegion()
sr4f1 = [((3,3),(4,3)),((4,3),(4,4)),((4,4),(3,3))]
sr4f1ID =sr4.addFace( sr4f1 )

t1 = 10
t2 = 20

# use the structural regions to create component interval regions
interReg1 = intervalRegion.cIntervalRegion()
interReg1.sourceSR = sr1
interReg1.destSR = sr2
interReg1.sourceTime = t1
interReg1.destTime = t2
interReg1.mapComponent( sr1f1ID, sr2f1ID ) 
#interReg1.mapComponent( sr1h1, sr2h1)
print interReg1, '---'
interReg2 = intervalRegion.cIntervalRegion()
interReg2.sourceSR = sr3
interReg2.destSR = sr4
interReg2.sourceTime = t1
interReg2.destTime = t2
interReg2.mapComponent( sr3f1ID, sr4f1ID )

print(interReg1.getStructuralRegionAtTime(11))
"""

def wktToSegmentList(wkt):
   #parses a WKT string and returns a list of tuples with floats with line segments representing a geometry
    geom = []
    geometry_type = wkt.split(" (")[0]
    if geometry_type == "POLYGON":
        #get all the coordinates inside. Does not take into account holes!
        coords_wkt = wkt.split("((")[1].split("))")[0].split(", ")
        x = 0.00
        for i in range(0, len(coords_wkt)-1):
            coords_wkt[i] = coords_wkt[i].split(" ")
            """if i == len(coords_wkt) or i==0:
                x = 0.0
            else:
                x += 0.01"""
            geom.append((float(coords_wkt[i][0]) +x , float(coords_wkt[i][1]) + x))

        segmentList = []
        #geom =  list(set(geom)) #remove duplicate points
        for i in range(0, len(geom)):
            if (i == len(geom)-1):
                segmentList.append((geom[i], geom[0]))#close the geometry
            else:
                segmentList.append((geom[i], geom[i+1]))
        return segmentList

#if len(sys.argv) != 6: #counting the name of the file as an argument
#    print "Usage: python mckerney.py <wkt source geom> <wkt target geom> <begin time> <end time> <query time>"
#    sys.exit(0)

geom1 = wktToSegmentList("POLYGON ((256.8359375 227.90468750000002, 266.11328125 215.69114583333334, 268.5546875 209.09583333333333, 267.578125 201.5234375, 268.798828125 196.39375, 274.90234375 191.50833333333333, 279.052734375 180.27187500000002, 278.3203125 171.47812499999998, 281.73828125 161.21875, 282.958984375 149.00520833333331, 278.80859375 143.38697916666666, 272.216796875 143.38697916666666, 265.13671875 153.64635416666667, 264.404296875 159.26458333333335, 260.498046875 163.17291666666665, 256.8359375 164.27213541666669, 253.173828125 165.37135416666666, 245.849609375 179.29479166666667, 231.4453125 205.92031250000002, 228.271484375 212.75989583333333, 216.30859375 243.04947916666666, 207.03125 273.33906249999995, 220.947265625 280.66718749999995, 228.515625 272.85052083333335, 238.525390625 265.76666666666665, 243.65234375 259.415625, 252.44140625 239.14114583333333, 256.8359375 227.90468750000002))")
geom2 = wktToSegmentList("POLYGON ((257.568359375 224.9734375, 261.962890625 221.06510416666669, 269.53125 206.653125, 268.798828125 198.83645833333333, 270.01953125 193.70677083333334, 276.611328125 188.3328125, 281.25 177.09635416666669, 279.296875 171.47812499999998, 283.69140625 158.77604166666669, 285.15625 145.82968749999998, 276.611328125 139.96718750000002, 273.681640625 140.94427083333335, 267.578125 151.20364583333333, 267.08984375 155.84479166666665, 263.18359375 160.24166666666667, 260.986328125 159.753125, 251.46484375 167.56979166666667, 243.1640625 188.57708333333335, 235.83984375 198.83645833333333, 225.09765625 217.40104166666669, 213.623046875 244.51510416666667, 207.03125 269.43072916666665, 220.458984375 276.75885416666665, 225.5859375 274.5604166666667, 228.759765625 268.69791666666663, 239.013671875 261.85833333333335, 244.384765625 255.26302083333334, 257.568359375 224.9734375))")

geom3 = wktToSegmentList("POLYGON ((1052 987, 1090 1037, 1100 1064, 1096 1095, 1101 1116, 1126 1136, 1143 1182, 1140 1218, 1154 1260, 1159 1310, 1142 1333, 1115 1333, 1086 1291, 1083 1268, 1067 1252, 1052 1247.5, 1037 1243, 1007 1186, 948 1077, 935 1049, 886 925, 848 801, 905 771, 936 803, 977 832, 998 858, 1034 941, 1052 987))")
geom4 = wktToSegmentList("POLYGON ((1055 999, 1073 1015, 1104 1074, 1101 1106, 1106 1127, 1133 1149, 1152 1195, 1144 1218, 1162 1270, 1168 1323, 1133 1347, 1121 1343, 1096 1301, 1094 1282, 1078 1264, 1069 1266, 1030 1234, 996 1148, 966 1106, 922 1030, 875 919, 848 817, 903 787, 924 796, 937 820, 979 848, 1001 875, 1055 999))")

geom5 = wktToSegmentList("POLYGON ((1001 875, 1055 999, 1064 1007, 1073 1015, 1104 1074, 1101 1106, 1106 1127, 1119.5 1138, 1133 1149, 1152 1195, 1144 1218, 1162 1270, 1165 1296.5, 1168 1323, 1133 1347, 1121 1343, 1096 1301, 1094 1282, 1078 1264, 1069 1266, 1049.5 1250, 1030 1234, 996 1148, 966 1106, 944 1068, 922 1030, 875 919, 848 817, 903 787, 924 796, 937 820, 979 848, 1001 875))")
geom6 = wktToSegmentList("POLYGON ((1030 942, 1078 1043, 1095 1054, 1118 1088, 1130 1114, 1128 1145, 1136 1170, 1146 1171, 1161 1184, 1184 1231, 1177 1254, 1198 1306, 1197 1327, 1207 1357, 1171 1384, 1161 1380, 1135 1348, 1125 1318, 1113 1306, 1102 1309, 1079 1297, 1058 1265, 1027 1194, 979 1138, 932 1052, 908 991, 892 971, 861 869, 919 837, 937 846, 951 869, 996 896, 1030 942))")

geom7 = wktToSegmentList("POLYGON ((216.23164062499998 225.87239583333334, 227.896484375 199.0703125, 229.84062500000002 197.34114583333334, 231.784765625 195.61197916666669, 238.48125000000002 182.859375, 237.83320312499998 175.94270833333334, 238.91328124999998 171.40364583333334, 241.8294921875 169.02604166666666, 244.745703125 166.6484375, 248.85 156.70572916666669, 247.12187500000002 151.734375, 251.01015625 140.49479166666669, 251.658203125 134.76692708333334, 252.30625 129.0390625, 244.745703125 123.85156250000001, 242.15351562499998 124.71614583333334, 236.75312499999998 133.79427083333334, 236.32109375000002 137.90104166666666, 232.86484375 141.79166666666666, 230.92070312500002 141.359375, 226.7083984375 144.81770833333331, 222.49609375 148.27604166666666, 215.15156249999998 166.86458333333334, 208.67109374999998 175.94270833333334, 203.91875000000002 184.15625, 199.16640625 192.36979166666669, 189.013671875 216.36197916666666, 183.18125 238.40885416666666, 195.062109375 244.89322916666666, 199.59843750000002 242.94791666666669, 202.406640625 237.76041666666666, 211.47929687500002 231.70833333333334, 216.23164062499998 225.87239583333334))")
geom8 = wktToSegmentList("POLYGON ((222.49609375 211.390625, 232.86484375 189.55989583333334, 236.537109375 187.18229166666666, 241.50546875 179.83333333333334, 244.09765625 174.21354166666666, 243.665625 167.51302083333331, 245.39374999999998 162.109375, 247.55390624999998 161.89322916666666, 250.79414062499998 159.08333333333334, 255.76250000000002 148.92447916666666, 254.250390625 143.953125, 258.78671875 132.71354166666666, 258.570703125 128.17447916666666, 260.730859375 121.69010416666666, 252.95429687499998 115.85416666666667, 250.79414062499998 116.71875, 245.177734375 123.63541666666667, 243.017578125 130.11979166666666, 240.425390625 132.71354166666666, 238.04921875 132.06510416666666, 233.08085937500002 134.65885416666666, 228.54453125 141.57552083333331, 221.848046875 156.921875, 211.47929687500002 169.02604166666666, 201.3265625 187.61458333333334, 196.1421875 200.79947916666666, 192.6859375 205.12239583333334, 185.98945312499998 227.16927083333331, 198.51835937500002 234.0859375, 202.406640625 232.14062499999997, 205.43085937499998 227.16927083333331, 215.15156249999998 221.33333333333334, 222.49609375 211.390625))")


geom1 = wktToSegmentList(sys.argv[1])
geom2 = wktToSegmentList(sys.argv[2])
sr1 = structureRegion.structuralRegion()
#geom1 = [((2,1),(4,1)),((4,1),(3,4)),((3,4),(2,1))]
sr1f1ID = sr1.addFace( geom1 )
sr2 = structureRegion.structuralRegion()
#geom2 = [((4,2),(5,2)),((5,2),(5,3)),((5,3),(4,2))]
sr2f1ID = sr2.addFace( geom2 )

interReg1 = intervalRegion.cIntervalRegion()
interReg1.sourceSR = sr1
interReg1.destSR = sr2

interReg1.sourceTime = int(sys.argv[3])
interReg1.destTime = int(sys.argv[4])
#interReg1.sourceTime = int(1000)
#interReg1.destTime = int(2000)
interReg1.mapComponent( sr1f1ID, sr2f1ID )
queryTime = int(sys.argv[5])
#queryTime = 1500
morph = interReg1.getStructuralRegionAtTime(queryTime)
print("result:")
print(morph)
